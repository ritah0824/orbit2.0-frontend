<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü™êORBIT - Pomodoro Focus</title>
    <link rel="stylesheet" href="./css/index.css">
    <link rel="stylesheet" href="./css/task.css">
    <style>
        .spotify-player {
            position: fixed;
            bottom: 80px;
            left: 20px;
            width: 400px;
            height: 80px;
            border-radius: 12px;
            overflow: hidden;
            display: none;
            z-index: 1000;
        }

        .spotify-player.active {
            display: block;
        }

        /* ‚úÖ NEW: Bigger icons in task header */
        .task-header-icons {
            display: flex;
            gap: 2vh;
            align-items: center;
        }

        .delete-btn,
        .add-btn {
            width: 5vh !important;  /* Much bigger! */
            height: 5vh !important;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .delete-btn:hover,
        .add-btn:hover {
            transform: scale(1.1);
        }

        /* Reserve space for task name - always visible but can be empty */
        #current-task-display {
            font-size: 2.94vh;
            letter-spacing: 0.26vh;
            min-height: 4vh;
            visibility: visible;
        }

        #current-task-display.empty {
            opacity: 0;
        }
    </style>
    <script src="./js/task.js"></script>
</head>

<body>
    <div id="page-bg" class="page-bg">
        <div class="top">POMODORO FOCUS</div>
        <div class="main" style="display: flex; width: 100%;margin-top: 8vh;height: 68vh;">
            <div class="main-left" style="width: 50%; border-right: 5px solid #FFFFFF; padding: 4.09vh 0 4.09vh 15vh;">
                <!-- ‚úÖ Task name display that reserves space -->
                <div id="current-task-display" class="empty">&nbsp;</div>
                
                <div class="time">
                    <div id="time-minute-1" class="time-num">2</div>
                    <div id="time-minute-2" class="time-num">5</div>
                    <div class="time-num" style="width: 5vh;">:</div>
                    <div id="time-second-1" class="time-num">0</div>
                    <div id="time-second-2" class="time-num">0</div>
                </div>
                <div id="left-title" class="work">LEFT TO WORK!</div>
                <div class="btn">
                    <div class="btn-item" onclick="reset()">RESET</div>
                    <div id="btn-start" class="btn-item" onclick="startClick()">START</div>
                </div>
            </div>
            <div class="main-right" style="width: 50%;padding: 0 15vh;">
                <!-- ‚úÖ UPDATED: Bigger icons with better layout -->
                <div style="display: flex; margin-top: 4.1vh; justify-content: space-between; align-items: center;" id="task-top">
                    <div style="font-size: 4.2vh; width: 14.56vh; letter-spacing: 0.26vh;">TASKS</div>
                    <div class="task-header-icons">
                        <img class="delete-btn" src="./images/delete.png" alt="Delete all tasks" onclick="deleteAll()">
                        <img class="add-btn" src="./images/add.png" alt="Add new task" onclick="clickAdd()">
                    </div>
                </div>
                <div id="task-list" style="font-size: 3.94vh;letter-spacing: 0.3vh; margin-top: 5vh;"></div>
            </div>
        </div>
        <div class="bottom">
            <div class="bottom-left">
                <img id="play-pause-btn" class="bottom-img" src="./images/play.png" alt="" onclick="toggleMusic()">
                <img class="bottom-img" style="width: 16px;" src="./images/change_music.png" alt=""
                    onclick="changeMusic()">
                <img class="bottom-img" src="./images/music.png" alt="">
                <div id="song-title">Brandenburg Concerto No.4 in G Major, BWV10 49: L. Allegro</div>
            </div>
            <div class="bottom-right" onclick="getNASAImage()">
                <div>change a Pic</div>
                <img class="bottom-img" src="./images/change_image.png" alt="">
            </div>
        </div>
    </div>

    <audio id="audio-bg" style="visibility: hidden;"></audio>

    <!-- Spotify Player -->
    <div id="spotify-player" class="spotify-player">
        <iframe id="spotify-iframe" style="border-radius:12px" width="100%" height="80" frameBorder="0"
            allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
            loading="lazy"></iframe>
    </div>

    <script src="./js/index.js"></script>
    <script>
        // NASA, Quotes, Spotify API code stays exactly the same...
        let usedDates = [];
        let tracksUri = "";
        let accessToken = "";
        let trackList = [];
        let currentTrackUri = "";
        let isPlaying = false;
        let nasaAttempts = 0;

        function getRandomNASADate() {
            const startDate = new Date('1995-06-16');
            const endDate = new Date('2025-01-06');
            let randomDate;
            let attempts = 0;

            do {
                const startTime = startDate.getTime();
                const endTime = endDate.getTime();
                const randomTime = startTime + Math.random() * (endTime - startTime);
                randomDate = new Date(randomTime);
                attempts++;

                if (attempts > 50) {
                    usedDates = [];
                    break;
                }
            } while (usedDates.includes(randomDate.toISOString().split('T')[0]));

            const year = randomDate.getFullYear();
            const month = String(randomDate.getMonth() + 1).padStart(2, '0');
            const day = String(randomDate.getDate()).padStart(2, '0');
            const dateStr = year + "-" + month + "-" + day;
            usedDates.push(dateStr);
            return dateStr;
        }

        function checkImageQuality(imageUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function () {
                    const width = this.naturalWidth;
                    const height = this.naturalHeight;
                    console.log(`Image dimensions: ${width}x${height}`);
                    const minWidth = 1920;
                    const minHeight = 1080;
                    if (width >= minWidth && height >= minHeight) {
                        console.log('‚úì Image is high quality!');
                        resolve(true);
                    } else {
                        console.log('‚úó Image too small, trying another...');
                        resolve(false);
                    }
                };
                img.onerror = function () {
                    console.log('‚úó Image failed to load, trying another...');
                    resolve(false);
                };
                setTimeout(() => {
                    console.log('‚úó Image load timeout, trying another...');
                    resolve(false);
                }, 5000);
                img.src = imageUrl;
            });
        }

        async function getNASAImage() {
            if (nasaAttempts > 20) {
                console.log('Too many attempts, stopping...');
                nasaAttempts = 0;
                return;
            }
            nasaAttempts++;
            const dateStr = getRandomNASADate();
            console.log(`[Attempt ${nasaAttempts}] Fetching NASA image for date: ${dateStr}`);

            try {
                const response = await fetch('https://api.nasa.gov/planetary/apod?api_key=nadHSFcvaHdLHtlXiPwRjMeOS9vKdgvTYZFgh9c1&date=' + dateStr);
                if (!response.ok) throw new Error('NASA API request failed');
                const data = await response.json();
                console.log('NASA image received:', data.title);

                if (data.media_type !== 'image') {
                    console.log('Got a video instead of image, fetching another date...');
                    getNASAImage();
                    return;
                }

                const imageUrl = data.hdurl || data.url;
                const isHighQuality = await checkImageQuality(imageUrl);

                if (isHighQuality) {
                    document.querySelector(".page-bg").style.backgroundImage = "url('" + imageUrl + "')";
                    document.querySelector("#page-bg").classList.add('page-bg-active');
                    setTimeout(() => {
                        document.querySelector("#page-bg").classList.remove('page-bg-active');
                    }, 250);
                    nasaAttempts = 0;
                } else {
                    console.log('Fetching another date for better quality...');
                    getNASAImage();
                }
            } catch (error) {
                console.error('NASA API Error:', error);
                getNASAImage();
            }
        }

        function getQuotes() {
            console.log('Fetching quote...');
            const quoteAPIs = [
                {
                    name: 'DummyJSON',
                    url: 'https://dummyjson.com/quotes/random',
                    headers: {},
                    parse: (data) => ({ content: data.quote, author: data.author })
                },
                {
                    name: 'API Ninjas',
                    url: 'https://api.api-ninjas.com/v1/quotes?category=inspirational',
                    headers: {},
                    parse: (data) => ({ content: data[0].quote, author: data[0].author })
                },
                {
                    name: 'Quotable',
                    url: 'https://api.quotable.io/quotes/random',
                    headers: {},
                    parse: (data) => ({ content: data[0].content, author: data[0].author })
                },
                {
                    name: 'ZenQuotes (CORS proxy)',
                    url: 'https://corsproxy.io/?https://zenquotes.io/api/random',
                    headers: {},
                    parse: (data) => ({ content: data[0].q, author: data[0].a })
                }
            ];
            tryQuoteAPI(0, quoteAPIs);
        }

        function tryQuoteAPI(index, apis) {
            if (index >= apis.length) {
                console.log('All quote APIs failed, using static quotes');
                useStaticQuote();
                return;
            }
            const api = apis[index];
            console.log(`Trying quote API: ${api.name}`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);

            fetch(api.url, {
                headers: api.headers,
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    console.log(`${api.name} response status:`, response.status);
                    if (!response.ok) {
                        throw new Error(`${api.name} failed with status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`${api.name} quote received:`, data);
                    const parsed = api.parse(data);
                    if (parsed.content && parsed.author) {
                        // document.querySelector("#quotes-content").innerHTML = parsed.content;
                        // document.querySelector("#quotes-author").innerHTML = parsed.author;
                    } else {
                        throw new Error('Invalid quote data received');
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.error(`${api.name} Error:`, error.message);
                    tryQuoteAPI(index + 1, apis);
                });
        }

        function useStaticQuote() {
            const staticQuotes = [
                { content: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
                { content: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill" },
                { content: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
                { content: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
                { content: "It does not matter how slowly you go as long as you do not stop.", author: "Confucius" },
                { content: "The secret of getting ahead is getting started.", author: "Mark Twain" },
                { content: "Don't watch the clock; do what it does. Keep going.", author: "Sam Levenson" },
                { content: "The harder you work for something, the greater you'll feel when you achieve it.", author: "Anonymous" }
            ];
            const randomQuote = staticQuotes[Math.floor(Math.random() * staticQuotes.length)];
            document.querySelector("#quotes-content").innerHTML = randomQuote.content;
            document.querySelector("#quotes-author").innerHTML = randomQuote.author;
            console.log('Using static quote');
        }

        function getSpotifyToken() {
            const clientId = '192eb498ca6344ec9ed9265249cbb2b5';
            const clientSecret = '024c34f7ae3147a0b341d106900d42b9';
            const credentials = btoa(clientId + ':' + clientSecret);
            console.log('Requesting Spotify token...');

            fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': 'Basic ' + credentials
                },
                body: 'grant_type=client_credentials'
            })
                .then(response => {
                    console.log('Token response status:', response.status);
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error('Token request failed: ' + text);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Token received successfully');
                    accessToken = data.access_token;
                    searchSpotifyTracks();
                })
                .catch(error => {
                    console.error('Spotify Token Error:', error);
                    document.querySelector("#song-title").innerHTML = "Brandenburg Concerto No.4 in G Major, BWV1049: I. Allegro";
                });
        }

        function searchSpotifyTracks() {
            const searchQueries = [
                'classical piano',
                'bach',
                'mozart',
                'beethoven',
                'focus music',
                'study music'
            ];
            const query = searchQueries[Math.floor(Math.random() * searchQueries.length)];
            console.log('Searching Spotify for:', query);

            fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=50`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            })
                .then(response => {
                    console.log('Search response status:', response.status);
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error('Search request failed: ' + text);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Search results received:', data);
                    if (data.tracks && data.tracks.items && data.tracks.items.length > 0) {
                        trackList = data.tracks.items;
                        displayRandomTrack();
                    } else {
                        console.log('No tracks found');
                        document.querySelector("#song-title").innerHTML = "Brandenburg Concerto No.4 in G Major, BWV1049: I. Allegro";
                    }
                })
                .catch(error => {
                    console.error('Spotify Search Error:', error);
                    document.querySelector("#song-title").innerHTML = "Brandenburg Concerto No.4 in G Major, BWV1049: I. Allegro";
                });
        }

        function displayRandomTrack() {
            if (trackList.length > 0) {
                const randomIndex = Math.floor(Math.random() * trackList.length);
                const track = trackList[randomIndex];
                if (track && track.name && track.artists && track.artists[0]) {
                    const trackName = track.name;
                    const artistName = track.artists.map(artist => artist.name).join(', ');
                    document.querySelector("#song-title").innerHTML = `${trackName} - ${artistName}`;
                    currentTrackUri = track.id;
                    console.log('Displaying track:', trackName, '-', artistName, 'ID:', currentTrackUri);
                }
            }
        }

        function changeMusic() {
            if (trackList.length > 0) {
                displayRandomTrack();
                if (isPlaying) {
                    updateSpotifyPlayer();
                }
            } else {
                searchSpotifyTracks();
            }
        }

        function toggleMusic() {
            if (!currentTrackUri) {
                alert('Please wait for music to load...');
                return;
            }
            const playerDiv = document.getElementById('spotify-player');
            const playPauseBtn = document.getElementById('play-pause-btn');

            if (!isPlaying) {
                updateSpotifyPlayer();
                playerDiv.classList.add('active');
                isPlaying = true;
                playPauseBtn.src = './images/pause.png';
                console.log('Playing music...');
            } else {
                playerDiv.classList.remove('active');
                isPlaying = false;
                playPauseBtn.src = './images/play.png';
                console.log('Pausing music...');
            }
        }

        function updateSpotifyPlayer() {
            if (currentTrackUri) {
                const iframe = document.getElementById('spotify-iframe');
                iframe.src = `https://open.spotify.com/embed/track/${currentTrackUri}?utm_source=generator&theme=0`;
            }
        }

        // Initialize
        getNASAImage();
        getQuotes();
        getSpotifyToken();
        getTasks();
    </script>
</body>

</html>
